---
title: è®°å½•æœ€è¿‘åšçš„ä¸¤ä¸ªæµè§ˆå™¨ï¼ˆChromeå†…æ ¸ï¼‰æ‰©å±•
date: 2024-03-21
---

import HarDemo from './HAR';
import Chat from './Chat';
import Write from "./Write";
import Gpt from "./GPT";

### æ‰©å±•ä¸€ï¼š HAR Debugger ä¸€ä¸ªå¯ä»¥å¸®åŠ©å¼€å‘è€…å¿«é€Ÿå®šä½å®¢æˆ·ç½‘ç»œæˆ–è€…äº§å“é—®é¢˜çš„å·¥å…·æ’ä»¶

äº§å“å†…éƒ¨è‡ªæµ‹é€šè¿‡ï¼Œäº¤ä»˜ç”¨æˆ·ååœ¨ç”¨æˆ·çš„ç”µè„‘ğŸ’»ä¸Šå¥”æºƒäº†ï¼Œå®¢æˆ·æŠ•è¯‰äº§å“åƒåœ¾æ€ä¹ˆåŠï¼Ÿ

#### ä»€ä¹ˆæ˜¯HARåŒ…ï¼Ÿ

å®šä¹‰ï¼šHTTPå­˜æ¡£æ ¼å¼ï¼ˆHTTP Archive formatï¼Œç®€ç§°HARï¼‰æ˜¯ä¸€ç§JSONæ ¼å¼çš„å­˜æ¡£æ–‡ä»¶æ ¼å¼ï¼Œå¤šç”¨äºè®°å½•ç½‘é¡µæµè§ˆå™¨ä¸ç½‘ç«™çš„äº¤äº’è¿‡ç¨‹ã€‚æ–‡ä»¶æ‰©å±•åé€šå¸¸ä¸º.har

â€œHARæ ¼å¼çš„è§„èŒƒå®šä¹‰äº†ä¸€ä¸ªHTTPäº‹åŠ¡çš„å­˜æ¡£æ ¼å¼ï¼Œå¯ç”¨äºç½‘é¡µæµè§ˆå™¨å¯¼å‡ºåŠ è½½ç½‘é¡µæ—¶çš„è¯¦ç»†æ€§èƒ½æ•°æ®Â  â€									â€”â€”Wikipedia

å¦‚ä¸‹æ‰€ç¤ºï¼šé€šè¿‡æ”¹æ‰©å±•å¯ä»¥å¸®ä½ä½ æ–¹ä¾¿åœ°è®°å½•å®¢æˆ·ç”µè„‘ä¸Šä¸€æ®µæ—¶é—´å‘ç”Ÿçš„ç½‘ç»œæ—¶é—´ï¼Œé€šè¿‡ç”Ÿæˆçš„HARåŒ…æ–‡ä»¶ï¼Œæ–¹ä¾¿åœ¨è‡ªå·±æœ¬åœ°ç”µè„‘å¤ç°ï¼ğŸ¥¸ï¼ˆå¥½å§ï¼Œæˆ‘æ‰¿è®¤è¿™åœºæ™¯æœ‰ç‚¹æ— èŠğŸ¥±ï¼‰
<HarDemo></HarDemo>

#### åè®°

å…³äºè¿™ä¸ªHARæ‰©å±•å…¶å®ä¸€å¼€å§‹æˆ‘æ˜¯æ‰“ç®—çº¯æ‰‹å·¥æ‹¼æ¥çš„æ–¹å¼ğŸ‘‹ æŠŠè¿™ä¸ªharç»™æ”’å‡ºæ¥çš„ï¼Œå¤´é“è¯•äº†ä¸€æ®µæ—¶é—´å‘ç° **è‡£å¦¾åšä¸åˆ°å•Šï½ï½ğŸ˜­**

é‡Œé¢æ¶‰åŠåˆ°çš„å­—æ®µå¾ˆå¤šï¼Œå…·ä½“å¯ä»¥æŸ¥çœ‹è¿™ä¸ªé“¾æ¥ğŸ”—ï¼š http://www.softwareishard.com/blog/har-12-spec/

è€Œä¸”è¿™äº›å­—æ®µéƒ½æ¥è‡ªé¡µé¢åŠ è½½è¿‡ç¨‹ä¸­çš„ä¸åŒäº‹ä»¶ï¼Œä¸”ä¸å°‘æœ‰ä¾èµ–å…³ç³»ï¼Œæˆ‘ç²—ç•¥ç»Ÿè®¡äº†ä¸€ä¸‹è‡³å°‘éœ€è¦ç›‘å¬ä»¥ä¸‹è¿™äº›äº‹ä»¶ğŸ‘‡
```js
[
'Page.loadEventFired',
'Page.domContentEventFired',
'Page.frameStartedLoading',
'Page.frameAttached',
'Network.requestWillBeSent',
'Network.requestServedFromCache',
'Network.dataReceived',
'Network.responseReceived',
'Network.resourceChangedPriority',
'Network.loadingFinished',
'Network.loadingFailed',
...
]
```
æœ‰äº›æ•°æ®çš„ç»„ç»‡è¿‡ç¨‹éœ€è¦è·¨äº‹ä»¶æ¥æ”’ï¼Œè™½ç„¶è¯´æ¯ä¸ªè¯·æ±‚éƒ½æœ‰ä¸€ä¸ªrequestIdæ¥ä¸²èµ·æ¥ï¼Œä½†æ˜¯å…¶ä¸­çš„**æ‹¼æ¥è§„åˆ™** æˆ‘è¿˜æ˜¯æ‹¿ä¸å‡†ğŸ˜­

äºæ˜¯å°±æ”¾å¼ƒäº†çº¯æ‰‹å·¥æ”’æ•°æ®çš„æ–¹å‘ï¼Œå¼€å§‹æ±‚åŠ©ç¤¾åŒºï¼Œæœç„¶åœ¨ä¸‡èƒ½çš„*npm*é‡Œè¢«æˆ‘å‘ç°äº†è¿™ä¸ªğŸ‘‰ï¼š[Chrome-har](https://www.npmjs.com/package/chrome-har)

çœ‹è¯¥packageçš„ç®€ä»‹ï¼š

    â€œCreate HAR files based on Chrome DevTools Protocol data.

    Code originally extracted from Browsertime,

    initial implementation inspired by Chromedriver_har.â€

ç®€ä»‹ä¸­çš„ç¬¬ä¸€å¥è¯æ­£æ˜¯æˆ‘è¦çš„ï¼Œåé¢æåˆ°äº†å¦ä¸€ä¸ªå·¥å…· **Browsertime** æˆ‘å»çœ‹äº†ä¸‹ï¼Œå¾ˆå¼ºå¤§ä¸è¿‡æˆ‘ç”¨ä¸åˆ°ï½ï¼Œæ„Ÿå…´è¶£çš„å°ä¼™ä¼´å¯ä»¥å»äº†è§£ä¸€ä¸‹ [Browsertime](https://github.com/sitespeedio/browsertime)

*npm install chrome-har* ç›´æ¥å¼€æ âŒ¨ï¸

```js
/*background.js*/

// é¦–å…ˆæˆ‘åœ¨åå°è„šæœ¬çš„å…¨å±€ç¯å¢ƒä¸‹åˆå§‹åŒ–äº†å‡ ä¸ªå˜é‡ï¼Œåˆ†åˆ«ç”¨æ¥è¡¨ç¤ºå½“å‰æ˜¯å¦æ­£åœ¨è®°å½•ç½‘ç»œäº‹ä»¶ã€
// å½“å‰é€šä¿¡çš„tabé¡µç­¾ã€ç½‘é¡µåç§°(è¿™ä¸ªåé¢ç»™ç”Ÿæˆçš„haråŒ…å‘½åç”¨)ï¼Œ
// ä»¥åŠä¸€ä¸ªç”¨æ¥ä¿å­˜æ”¶é›†åˆ°çš„äº‹ä»¶å¯¹è±¡çš„æ•°ç»„ï¼Œè¿™ä¸ªç”¨æ¥â€œå–‚â€ ç»™chrome-har ç”Ÿæˆæˆ‘éœ€è¦çš„æ–‡ä»¶
let recording = false;
let tabId = void 0;
let tabTitle = '';
let networkEvents = []; // æ”¶é›†æ‰€æœ‰çš„äº‹ä»¶å¯¹è±¡


// å®šä¹‰chromeæ‰©å±•çš„debuggeräº‹ä»¶ç›‘å¬å‡½æ•°
const debuggerEventListener = (debuggeeId, method, params) => {
    networkEvents.push({method, params}); // æŠŠç›‘å¬åˆ°çš„äº‹ä»¶ä¸€è‚¡è„‘å„¿å…¨æ”¾ networkEvents é‡Œé¢
}

// ç›‘å¬å¼€å§‹çš„å‡½æ•°ï¼Œéœ€è¦è°ƒç”¨chrome.debugger.attachæ–¹æ³•å°†è¦ç›‘å¬çš„ç½‘é¡µtabIdç»‘å®š
// å¹¶å¼€å¯å¯¹ 'Network.enable' å’Œ 'Page.enable' ç³»åˆ—äº‹ä»¶çš„ç›‘å¬
const startRecording = () => {
    // https://developer.chrome.com/docs/extensions/reference/api/debugger?hl=zh-cn#method-attach
    chrome.debugger.attach({ tabId }, '1.2', function () {
        chrome.debugger.sendCommand({ tabId }, 'Network.enable', {});
        chrome.debugger.sendCommand({tabId}, 'Page.enable', {}); // pageäº‹ä»¶åŒ…å«æ—¶é—´ä¿¡æ¯ï¼Œéœ€è¦æ·»åŠ ç›‘å¬
    });
    recording = true;
}

// åœæ­¢ç›‘å¬å‡½æ•°ï¼Œè°ƒç”¨chrome.debugger.detach æ–¹æ³•è§£é™¤å¯¹ç›‘å¬çš„ç½‘é¡µçš„ç»‘å®š
const stopRecording = () => {
    chrome.debugger.detach({tabId}, function () {
        recording = false;
    })
}

// åˆå§‹åŒ–ï¼šbackgroundè„šæœ¬åˆšåŠ è½½ä¹Ÿå°±æ˜¯æ‰©å±•åˆšè¿›å…¥å·¥ä½œæ—¶æ‰§è¡Œçš„ä¸€ä¸ªç»™æ‰©å±•iconæ·»åŠ ä¸€ä¸ªOFFå­—æ®µï¼Œ
// è¡¨ç¤ºæœªå·¥ä½œ
chrome.runtime.onInstalled.addListener(() => {
    chrome.action.setBadgeText({
        text: 'OFF' // é»˜è®¤off
    });
});

// å½“ç”¨æˆ·ç‚¹å‡»æ‰©å±•iconæ—¶å€™çš„ç›‘å¬å‡½æ•°
chrome.action.onClicked.addListener((tab) => {
    tabId = tab.id; // è®¾ç½®tabId
    tabTitle = tab.title; // è®¾ç½®tabTitle
    chrome.action.getBadgeText({ tabId: tab.id }, function (preState) {
        const nextState = preState === 'ON' ? 'OFF' : 'ON'; // åˆ‡æ¢å½“å‰çš„å·¥ä½œçŠ¶æ€çš„æ˜¾ç¤º
        chrome.action.setBadgeText({
            tabId: tab.id,
            text: nextState
        });
        if (nextState === 'ON') {
            startRecording(); // å¼€å¯ç›‘å¬ -> attach
            chrome.debugger.onEvent.addListener(debuggerEventListener); // ç›‘å¬å›è°ƒ
        } else if (nextState === 'OFF') {
            stopRecording(); // åœæ­¢ç›‘å¬ -> detach
            chrome.debugger.onEvent.removeListener(debuggerEventListener); // ç§»é™¤ç›‘å¬å›è°ƒ
            // è¿™é‡Œæˆ‘ä»¬æŠŠæ”¶é›†åˆ°çš„äº‹ä»¶åšäº†ä¸€ä¸ªè¿‡æ»¤ï¼Œå»é™¤é‡Œé¢çš„Page.frameResizedäº‹ä»¶ï¼Œè¿™ä¸ªæ˜¯è®°å½•å¼€å§‹æ—¶é¡¶éƒ¨ä¼šæœ‰ä¸€ä¸ªæç¤ºæ‰©å±•æ­£åœ¨è°ƒè¯•è¯¥é¡µé¢çš„
            // æç¤ºä¿¡æ¯å¯¼è‡´é¡µé¢å°ºå¯¸å‘ç”Ÿå˜åŠ¨ï¼Œè¿™ä¸ªäº‹ä»¶å¯¹äºæˆ‘ä»¬æœ€ç»ˆæ”¶é›†æ•°æ®æ²¡ç”¨å¾’å ç©ºé—´ï¼Œå› æ­¤æˆ‘ä»¬ç›´æ¥æŠŠå®ƒè¿‡æ»¤å‡ºå»
            networkEvents = networkEvents.filter(item => item.method !== 'Page.frameResized');
            // åœ¨æŠŠæ”¶é›†åˆ°çš„äº‹ä»¶ä¿¡æ¯å‘é€ç»™å‰å°ä¹‹å‰ï¼Œåšä¸€ä¸ªæ£€æŸ¥âœŠ
            if (networkEvents.length) {
                // åˆ©ç”¨chrome.tabs.sendMessageæ¶ˆæ¯é€šä¿¡å°†åå°æ”¶é›†åˆ°çš„æ•°æ®å‘é€ç»™å‰å°
                chrome.tabs.sendMessage(tabId, {
                    type: 'Har',
                    harData: networkEvents,
                    name: tabTitle
                }, null, (response) => {
                    if (response && response.action === 'clear') {
                        networkEvents = [];
                    }
                })
            } else {
                alert('æ²¡æœ‰ç›‘å¬åˆ°ä»»ä½•æœ‰æ•ˆæ•°æ®ï¼Œè¯·é‡æ–°æ“ä½œã€‚');
            }
        }
    })
});

```
```js
/*content.js å‰å°è„šæœ¬*/

// å¼•å…¥æˆ‘ä»¬å®‰è£…çš„chrome-har (æ³¨æ„ï¼šè¿™æ˜¯ä¸€ä¸ªnodeåŒ…ï¼Œæ‰€ä»¥æˆ‘ä»¬ä½¿ç”¨commonjsçš„æ–¹å¼requireå¼•å…¥)
const { harFromMessages } = require('chrome-har');

// ç›‘å¬å‡½æ•°é€»è¾‘
const backgroundListener = (message, sender, sendResponse) => {
    // sender.id æ˜¯æ‰©å±•çš„id "njjdcblpajfbeljfhfgiielnhgkdmhkn"
    if (message.type === 'Har') {
        // è°ƒç”¨chrome-haråŒ…æä¾›çš„ harFromMessages æ–¹æ³•ç”Ÿæˆ haræ–‡ä»¶
        const har = harFromMessages(message.harData, {includeTextFromResponseBody: true, includeResourcesFromDiskCache: true});
        if (!har.log.pages.length || !har.log.entries.length) {
            alert('æ²¡æœ‰ç›‘å¬åˆ°ä»»ä½•æœ‰æ•ˆæ•°æ®ï¼Œè¯·é‡æ–°æ“ä½œã€‚');
        }

        // ä¸‹é¢ğŸ‘‡çš„æ“ä½œå°±æ˜¯ç”Ÿæˆå®ŒharåŒ…åè‡ªåŠ¨ä¸‹è½½â¬
        const blob = new Blob([JSON.stringify(har)], {
            type: "application/json",
        });
        const downloadLink = document.createElement('a');
        downloadLink.href = URL.createObjectURL(blob);
        downloadLink.download = `${message.name}.har`;
        downloadLink.textContent = 'Download HAR';
        document.body.appendChild(downloadLink);
        downloadLink.click();
        document.body.removeChild(downloadLink);
        // å®Œæˆä¹‹åè®°å¾—é€šçŸ¥åå°è„šæœ¬åšã€æ¸…ç©ºã€‘å¤„ç†ï¼Œå¦åˆ™ä¸‹æ¬¡è®°å½•ç½‘ç»œäº‹ä»¶ä¼šå¸¦ä¸Šä¸Šä¸€æ¬¡çš„æ•°æ®
        sendResponse({
            action: 'clear'
        })
    }
}

// ç›‘å¬ä»åå°ä¼ é€’è¿‡æ¥çš„æ¶ˆæ¯
chrome.runtime.onMessage.addListener(backgroundListener);

```
ç”±äº **chrome-har** æ˜¯ä¸€ä¸ªcommonjsæ ¼å¼çš„nodeåŒ…ï¼Œå› æ­¤æˆ‘ä»¬ä¸èƒ½æ„‰å¿«çš„ç”¨viteè¿›è¡Œæ„å»ºæ‰“åŒ…åªèƒ½é‡æ‹¾webpackï¼Œç®€å•å†™ä¸ªé…ç½®æ–‡ä»¶ npm run build æ‰§è¡Œ webpack èµ°èµ·!

```js
/*webpack.config.js*/

const path = require('path');
module.exports = {
    entry: '/src/content.js',
    output: {
        filename: 'content.js',
        path: path.resolve(__dirname, 'dist'),
    },
};
```
æœ¬ä»¥ä¸ºè¿™æ ·å°±ç»“æŸäº†ï¼Œä½†æ˜¯å®‰è£…ä¸Šæ‰©å±•åˆ°æµè§ˆå™¨è¿›è¡Œæµ‹è¯•å‘ç°ï¼Œå¯¼å‡ºçš„haråŒ…ä¸­è¯·æ±‚å¤´ã€å¦‚å‚ã€urlã€æ—¶é—´ä¿¡æ¯...è¿™äº›éƒ½æœ‰ï¼Œå”¯ç‹¬æ²¡æœ‰å“åº”å®ä½“ä¿¡æ¯ğŸ˜ºã€‚ã€‚ã€‚

è¿™ä¸ªä¸å°´å°¬äº†å˜›ğŸ˜…ï¼Œæ²¡æœ‰å“åº”æ•°æ®æˆ‘çœ‹ä¸ªæ¯›å•Šï¼Œç™½æŠ˜è…¾å•Šï¼Œäºæ˜¯æˆ‘è·‘åˆ°äº†ä½œè€…çš„githubä¸»é¡µï¼Œå»issuesä¸­è¯•å›¾å¯»æ‰¾æœ‰æ²¡æœ‰ç±»ä¼¼é—®é¢˜ï¼Œæœç„¶è¢«æˆ‘æ‰¾åˆ°

![alt text](/img/harissues1.png)

è¿™ä¸ªissueä¸‹é¢æœ‰å¾ˆå¤šè®¨è®ºï¼Œåé¢ä½œè€…åœ¨ä¸€ç³»åˆ—çš„å›å¤ä¸­è¡¨ç¤ºï¼Œä¸ä¼šå•ç‹¬åœ¨chrome-harä¸­å®ç°è¯¥åŠŸèƒ½ï¼Œchrome-har å°†åªä¼šä½œä¸ºä½¿ç”¨å·²æœ‰æ•°æ®ç»„è£…haræ–‡ä»¶çš„ç®€å•å·¥å…·

![alt text](/img/harissues2.png)

ç•¥å¸¦äº›è®¸æ²®ä¸§çš„æˆ‘æ— å¥ˆæ‰“å¼€äº†chrome-harçš„æºç è¿›è¡ŒæŸ¥çœ‹ï¼Œåœ¨å…¶ä¸­çœ‹åˆ°è¿™æ ·ä¸€è¡Œæ³¨é‡ŠğŸ‘€ï¼š

![alt text](/img/common.png)

æ„æ€å¾ˆæ˜ç¡®response.body éœ€è¦æˆ‘è‡ªå·±æä¾›ï¼Œå¹¶ä¸”ç»™æˆ‘ç”©å‡ºæ¥äº†ä¸€ä¸ªé“¾æ¥ [ğŸ”—https://chromedevtools.github.io/devtools-protocol/tot/Network#type-Response](https://chromedevtools.github.io/devtools-protocol/tot/Network#type-Response)

é“¾æ¥æ‰“å¼€ç›´æ¥å®šä½åˆ°äº†å¯¹äº Network.Response çš„å­—æ®µè§£æï¼Œä»ä¸­å¾—è¦æƒ³æ‹¿åˆ°response.bodyæˆ‘éœ€è¦è‡ªå·±é€šè¿‡ requestId ä»¥å¼‚æ­¥è¯·æ±‚çš„æ–¹å¼è·å–å¯¹åº”çš„ Network.Response å¹¶ä»ä¸­è§£æå‡º response.body

æ‰€ä»¥æˆ‘çš„åå°è„šæœ¬ä¸­éœ€åšä¿®æ”¹

```js
/*background.js*/

// ä¸»è¦å°±æ˜¯è°ƒæ•´è¿™ä¸ªäº‹ä»¶ç›‘å¬å‡½æ•°çš„å¤„ç†é€»è¾‘ï¼Œä¹‹å‰æ˜¯æŠŠæ‰€æœ‰ç›‘å¬åˆ°çš„äº‹ä»¶ä¸åšä»»ä½•å¤„ç†ä¸€è‚¡è„‘å„¿
// ç›´æ¥æ”¾networkEventsé‡Œé¢äº†ï¼Œç°åœ¨éœ€è¦åšçš„å°±æ˜¯å¯¹å…³è”å“åº”ç»“æœçš„äº‹ä»¶å•ç‹¬åšå¼‚æ­¥çš„è¯·æ±‚
// åœ¨è¿”å›çš„Network.Response ä¸­è§£æå‡º response.body
const debuggerEventListener = (debuggeeId, method, params) => {
    // networkEvents.push({method, params});
    if (recording && debuggeeId.tabId === tabId) {
      if (method !== 'Network.responseReceived' && method !== 'Network.dataReceived') {
        networkEvents.push({method, params});
      } else {
        const requestId = params.requestId;
        if (params.response) {
          chrome.debugger.sendCommand({ tabId: tabId }, "Network.getResponseBody", { requestId: requestId }, function (responseBody) {
            if (responseBody) {
              if (responseBody.body) {
                params.response.body = responseBody.body;
                networkEvents.push({method, params});
              } else {
                networkEvents.push({method, params});
              }
            } else {
              console.log('è·å–responseBodyå¤±è´¥');
              networkEvents.push({method, params});
            }
          });
        } else {
          networkEvents.push({method, params});
        }
      }
    } else {
        return;
    }
}
```
ç»è¿‡ä¸€æ³¢ä¸‰æŠ˜çš„ä¸€ç•ªæŠ˜è…¾åæ‰©å±•ç»ˆäºå¯ä»¥æ­£å¸¸å·¥ä½œäº†ï¼Œæ’’èŠ±ğŸ‰  æ‰©å±•å·²ç»å‘å¸ƒåˆ°Chromeæ‰©å±•å•†åº—ï¼Œæœç´¢ [HAR Debugger](https://chromewebstore.google.com/search/HAR%20Debugger) å³å¯æ‰¾åˆ°æ¬¢è¿ä¸‹è½½ä½¿ç”¨ğŸ‘




### æ‰©å±•äºŒï¼šAIæ™ºèƒ½åŠ©æ‰‹ + ç½‘é¡µåˆ’è¯

è¿™ä¸ªä¸œè¥¿æœ€è¿‘å¯æ˜¯å¤ªç«ğŸ”¥äº†ï¼Œå„ç§AIåŠ©æ‰‹...æ»¡å¤©é£ï¼Œè‡ªå·±ä¹Ÿåšäº†ä¸€ä¸ªï¼Œæ•ˆæœå¦‚ä¸‹ï¼š


##### èŠå¤©å†™ä½œâœï¸èƒ½åŠ›

<Chat></Chat>


##### ç½‘é¡µåˆ’è¯ç¿»è¯‘èƒ½åŠ›

<Write></Write>

è¿™é‡Œæ˜¯ç”¨äº† Shadowdom å°è£…äº†å…ƒç´ æ’å…¥åˆ°æ–‡æ¡£ä¸­å®ç°çš„

```js
// æ‰©å±•çš„content.js
const injectShadowDom = () => {
  const rootElement = document.createElement('div');
  rootElement.id = 'aiAssistRoot';
  // é˜²æ­¢é‡å¤æ³¨å…¥
  const rootDom = document.getElementById('aiAssistRoot');
  rootDom && rootDom.remove();
  // attachShadow to shadowHost
  const shadowRoot = rootElement.attachShadow({mode: 'open'});
  let reactContainer = document.createElement('div');
  reactContainer.id = 'reactContainer';
  shadowRoot.appendChild(reactContainer);
  document.body.appendChild(rootElement);
  // âš ï¸æ³¨æ„æˆ‘ä»¬çš„æ ·å¼éœ€è¦é€šè¿‡è¿™ç§æ–¹å¼æ’å…¥åˆ°shadowdomä¸­
  const styleNode = document.createElement('style');
  const styleUrl = chrome.runtime.getURL('content.css');
  fetch(styleUrl).then(res => res.text()).then(styleData => {
    styleNode.textContent = styleData;
    shadowRoot.appendChild(styleNode);
    // ä½¿ç”¨Antd çš„ StyleProvider å°†antdçš„æ ·å¼ä¹Ÿæ’å…¥åˆ°shadowdomä¸­
    // <Scribe/> å°±æ˜¯æˆ‘ä»¬é¡µé¢ä¸Šçœ‹åˆ°çš„åˆ’è¯å’Œå¯¹è¯ç»„ä»¶äº†
    createRoot(reactContainer).render(
        <StyleProvider container={shadowRoot}>
          <Scribe/>
        </StyleProvider>
    )
  })
}

injectShadowDom();
```

è¿™é‡Œéœ€è¦æ³¨æ„æ§åˆ¶ ç»„ä»¶æ‹–æ‹½çš„æ—¶å€™ä¸è¦â€œæº¢å‡ºâ€å±å¹•è¾¹ç¼˜

```js
// æ‹–æ‹½é™ä½
let x = 0;
let y = 0;
const mouseMoveHandler = (e: any) => {
    const clientWidth = document.documentElement.clientWidth || document.body.clientWidth;
    const clientHeight = document.documentElement.clientHeight || document.body.clientHeight;
    const dx = e.clientX - x;
    const dy = e.clientY - y;

    // é™ä½ï¼Œè¾¹ç¼˜ä¸è¶…å‡ºå±å¹•
    if (freeBoxRef.current) {
      if (freeBoxRef.current.offsetLeft + dx < 0) {
        freeBoxRef.current.style.left = '0px'; // å·¦ä¾§é™ä½
      } else if (freeBoxRef.current.offsetLeft + dx > clientWidth - 626) {
        freeBoxRef.current.style.left = `${clientWidth - 626}px`; // å³ä¾§é™ä½
      } else {
        freeBoxRef.current.style.left = `${freeBoxRef.current.offsetLeft + dx}px`; // å·¦å³ç§»åŠ¨èŒƒå›´
      }
      if (freeBoxRef.current.offsetTop + dy < 0) {
        freeBoxRef.current.style.top = '0px'; // é¡¶éƒ¨é™ä½
      } else if (freeBoxRef.current.offsetTop + dy > clientHeight - freeBoxRef.current.offsetHeight) {
        freeBoxRef.current.style.top = clientHeight - freeBoxRef.current.offsetHeight > 0 ? `${clientHeight - freeBoxRef.current.offsetHeight}px` : '0px'; // åº•éƒ¨é™ä½
      } else {
        freeBoxRef.current.style.top = `${freeBoxRef.current.offsetTop + dy}px`; // ä¸Šä¸‹æ´»åŠ¨èŒƒå›´
      }
    }
    x = e.clientX;
    y = e.clientY;
  }
```

##### æ”¹ç‰ˆUIåŠ å…¥å†å²å¯¹è¯
<Gpt></Gpt>

#### åè®°

ç½‘é¡µåˆ’è¯è¿™éƒ¨é—¨çš„åŠŸèƒ½ï¼Œå› ä¸ºæˆ‘ä»¬åœ¨ *content.js* ä¸­åŠ å…¥äº† React ç»„ä»¶çš„åˆ›å»º (createRoot) æ‰€ä»¥ï¼Œcontent.jséœ€è¦å•ç‹¬çš„ç¼–è¯‘æ‰“åŒ…
å•ç‹¬ç¼–å†™ *vite-content.js*

```js
/*vite-content.js*/
export default defineConfig({
  root: 'src',
  plugins: [
    react(),
    babel({
      babelHelpers: 'bundled',
      exclude: 'node_modules/**',
    })
  ],
  resolve: {
    alias: {
      '@': path.resolve(__dirname, 'src')
    }
  },
  // âš ï¸æ³¨æ„buildçš„é…ç½®
  build: {
    outDir: '../dist',
    assetsInlineLimit: 8392,
    rollupOptions: {
      input: {
        'content': '/ext/content.js' // æ‰“åŒ…å…¥å£è®¾ç½®
      },
      output: {
        entryFileNames: '[name].js', // æ‰“åŒ…çš„ç»“æœéœ€è¦ä¿æŒæ–‡ä»¶åä¸€è‡´
        // âš ï¸ ä¸å¯ä»¥ä½¿ç”¨ iife çš„æ–¹å¼ï¼Œiife ä¼šæŠŠ js å’Œ css éƒ½æ‰“åŒ…åˆ°ä¸€èµ·
        // format: 'iife',

        // é…ç½®æ‰“åŒ…å‡ºçš„å…¶ä»–èµ„æºï¼Œè¿™é‡Œå…¶å®å°±æ˜¯æˆ‘ä»¬çš„æ ·å¼ä»£ç ï¼Œå‘½åä¸º content.css
        // è¿™æ ·å°±å¯ä»¥é€šè¿‡ const styleUrl = chrome.runtime.getURL('content.css');
        // ç„¶å fetch(styleUrl).then...çš„æ–¹å¼æ‹¿åˆ°æˆ‘ä»¬çš„æ ·å¼ä»£ç äº†
        assetFileNames: 'content.[ext]'
      }
    },
  }
})
```
å¦å¤–æˆ‘çš„è¯·æ±‚ä¹Ÿæ”¾åˆ°åå°è„šæœ¬ *background.js* ä¸­å»äº†ï¼Œè¿™æ ·ç”¨æˆ·åœ¨é¡µé¢çš„ devtools çš„ç½‘ç»œè¯·æ±‚ä¸­å°±ä¸ä¼šçœ‹åˆ°æ‰©å±•çš„è¯·æ±‚äº†
å®ç°æ›´å¥½çš„å°è£…å’Œéšè—ğŸ«¥,æ­¤æ—¶å‰å°é€šè¿‡äº‹ä»¶è§¦å‘åå°å‘èµ·è¯·æ±‚ï¼Œå†ä»åå°æ¥å—è¿”å›çš„å“åº”å°±éœ€è¦ä¸€å¥—è‰¯å¥½çš„é€šä¿¡æœºåˆ¶ï¼Œåœ¨Chromeæ‰©å±•
ä¸­ä¸»è¦ç”¨ä¸¤ç§é€šä¿¡çš„æ–¹å¼ï¼š

1ã€chrome.runtime.sendMessage/chrome.tabs.sendMessageçŸ­é“¾æ¥çš„æ–¹å¼
2ã€chrome.runtime.connect/chrome.tabs.connecté•¿é“¾æ¥çš„æ–¹å¼

çŸ­è¿æ¥çš„è¯å°±æ˜¯æŒ¤ç‰™è†ä¸€æ ·ï¼Œæˆ‘å‘é€ä¸€ä¸‹ï¼Œä½ æ”¶åˆ°äº†å†å›å¤ä¸€ä¸‹ï¼Œå¦‚æœå¯¹æ–¹ä¸å›å¤ï¼Œä½ åªèƒ½é‡æ–°å‘ï¼Œè€Œé•¿è¿æ¥ç±»ä¼¼WebSocketä¼šä¸€ç›´å»ºç«‹è¿æ¥ï¼ŒåŒæ–¹å¯ä»¥éšæ—¶äº’å‘æ¶ˆæ¯ã€‚

è¿™é‡Œå¼€å§‹æˆ‘ä½¿ç”¨çš„æ˜¯çŸ­é“¾æ¥çš„æ–¹å¼ï¼Œä½†æ˜¯å‘ç°æœåŠ¡ç«¯SSEæ¨é€çš„æ•°æ®æµè¿‡æ¥çš„æ—¶å€™ï¼Œéœ€è¦ä¸æ–­çš„è§¦å‘ sendMessage å’Œ onMessage ç»å¸¸ä¼šå‡ºç°æ¶ˆæ¯é”™ä¹±ï¼ŒåŒä¸€ä¸ªæ¶ˆæ¯

å†…å®¹é‡å¤äº†å¤šæ¬¡çš„bugï¼Œæ”¹æˆé•¿é“¾æ¥çš„æ–¹å¼å°±å¥½äº†ğŸ‘Œã€‚

```js
/*content.jså‘background.js å‘èµ·é•¿é“¾æ¥*/
const port = chrome.runtime.connect({name: "exampleName"}); // éœ€è¦ä¼ é€’ä¸€ä¸ªå¸¦nameçš„å¯¹è±¡ï¼Œè¿”å›ä¸€ä¸ªport
...
// ä¹‹åå°±èƒ½åˆ©ç”¨è¿™ä¸ªportè¿›è¡Œæ¶ˆæ¯çš„å‘é€å’Œå“åº”äº†

// å‘é€è¯·æ±‚
port.postMessage({
  type: 'gptRequest',
  payload: {
    params
  }
});
// æ¥å—å“åº”
port.onMessage.addListener(msg => {
    ...
})

```

```js
/*background.jsä¸­ç›‘å¬æ¥è‡ªå‰å°çš„é“¾æ¥è¯·æ±‚å’Œæ¶ˆæ¯*/
chrome.runtime.onConnect.addListener(port => {
    // åŒºåˆ†æ¶ˆæ¯é€šé“
    if (port.name === 'exampleName') {
        port.onMessage.addListener(msg => {
            if (msg.type === 'aiRequest') {
                // å¯ä»¥åœ¨è¿™é‡Œå‘èµ·è¯·æ±‚äº†ï¼Œå› ä¸ºæœåŠ¡ç«¯è¿”å›çš„æ˜¯æµå¼æ•°æ®ï¼Œæ‰€ä»¥æˆ‘é‡‡ç”¨çš„fetchæ¥å¤„ç†
                const {params} = msg.payload;
                controller = new AbortController(); // ç»ˆæ­¢ä¿¡å·
                const {signal} = controller;
                requestAi(params, signal).then(res => {
                    const reader = res.body?.getReader();
                    const decoder = new TextDecoder('utf-8');
                    return new ReadableStream({
                      start(controller) {
                        function push() {
                          reader?.read().then(({done, value}) => {
                            if (done) {
                              port.postMessage({type: 'gptResponseDown'}); // å“åº”ç»“æŸ
                              return;
                            }
                            let str = decoder.decode(value);
                            if (str.includes('error') && str.includes('code') && !str.startsWith('data: ') && !str.includes('choices')) {
                              // æŠ¥é”™
                              port.postMessage({type: 'gptResponseError'}); // å“åº”æŠ¥é”™
                              controller.close();
                              return;
                            }
                            str = str.split('\n')
                                .filter((line) => line.startsWith('data: ') && line.includes('choices'))
                                .map((line) => JSON.parse(line.replace('data: ', '')).choices[0].delta.content).join('');
                            port.postMessage({
                              type: 'gptResponseValue',
                              payload: {
                                value: str
                              }
                            });
                            controller.enqueue(value);
                            push();
                          })
                        }
                        push();
                      }
                    })
                })
            } else if (msg.type === 'abortRequest') {
              controller.abort(); // ä¼šæŠ¥ä¸€ä¸ªDOMExceptionçš„å¼‚å¸¸æš‚æ—¶æ— æ³•æ•è·åˆ°ä¸å½±å“ä¸šåŠ¡ğŸ¤·â€â™€ï¸
            }
        })
    }
})
```



